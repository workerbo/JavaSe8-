### **分布式事务分类**

衍生出了的微服务架构，各个服务都是一个独立的JVM进程，并且都有自己独立的数据库和缓存服务，这时通过数据库本地事务无法保证分布式业务的一致性。

![img](https://pic1.zhimg.com/v2-ca8c6a898d02eea74108d24983e72028_b.jpg)

1.刚性事务

- 强一致性：各个业务操作必须在事务结束时全部成功，或者全部失败
- XA模型
- 满足CAP理论的CP

2PC两阶段提交：AP发起一个全局事务，TM发起一个prepare请求，RM在prepare阶段都执行成功，TM发起commit请求。在prepare阶段人意RM执行失败，TM发起rollback操作。

2.柔性事务

- 保证最终一致性，事务结束后在可接受的时间范围内，可能出现短暂的不一致，最终会达成一致性
- 满足CAP理论的AP，满足BASE理论



## **TCC模型**

TCC模型完全交由业务端实现，每个子业务都需要实现try-confirm-cancel接口，对业务侵入性很大。

资源锁定需要业务自主实现。

Try:尝试执行事务，完成业务检查，预留必要的资源。

confirm:真正执行业务，不做业务资源检查

cancel:释放try阶段预留的业务资源



不管是本地消息表还是事务消息，都需要保证从事务执行且仅仅执行一次，exact once。如果失败，需要重试，但也不可能无限次的重试，当从事务最终失败的情况下，需要通知主业务回滚吗？但是此时，主事务已经提交，因此只能通过补偿，实现逻辑上的回滚，而当前时间点距主事务的提交已经有一定时间，回滚也可能失败。因此，最好是保证从事务逻辑上不会失败，万一失败，记录log并报警，人工介入。



参考：https://zhuanlan.zhihu.com/p/246096231