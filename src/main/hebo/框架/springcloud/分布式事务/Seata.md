提供了 AT、TCC、SAGA 和 XA 事务模式。Seata 融合了阿里巴巴和蚂蚁金服在分布式事务技术上的积累。

Seata 的设计目标是对业务无侵入，因此从业务无侵入的 2PC 方案着手，在传统 2PC 的基础上演进。它把一个[分布式事务](https://so.csdn.net/so/search?q=分布式事务&spm=1001.2101.3001.7020)理解成一个包含了若干分支事务的全局事务。全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功提交，要么一起失败回滚。通常分支事务本身就是一个关系型数据库的本地事务。

###### Seata 的三大组件

与 传统2PC 的模型类似，Seata定义了3个组件来协议分布式事务的处理过程：

TC：Transaction Coordinator 事务协调器，它是独立的中间件，需要独立部署运行，它维护全局事务的运
行状态，接收TM指令发起全局事务的提交与回滚，负责与RM通信协调各各分支事务的提交或回滚。

TM：Transaction Manager 事务管理器，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。**发起一个分布式事务的就是一个TM**。

RM：Resource Manager 资源管理器，管理分支事务处理的资源，向 TC 注册分支事务，上报分支事务的状态，接受 TC的命令来提交或者回滚分支事务、

![在这里插入图片描述](https://img-blog.csdnimg.cn/2021053109195678.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODY1MDg5OA==,size_16,color_FFFFFF,t_70)

###### Seata 的执行流程

1）A 服务的 TM 向 TC 申请开启一个全局事务，TC 就会创建一个全局事务并返回一个唯一的 XID，XID在调用链路上传播。
		2）A 服务的 RM 向 TC 注册分支事务，并将其纳入 XID 对应全局事务的管辖
		3）A 服务执行分支事务，向数据库执行操作
		4）A 服务开始远程调用 B 服务，此时 XID 会在微服务的调用链上传播
		5）B 服务的 RM 向 TC 注册分支事务，并将其纳入 XID 对应的全局事务的管辖
		6）B 服务执行分支事务，向数据库执行操作
		7）全局事务调用链处理完毕，TM 根据有无异常向 TC 发起全局事务的提交或者回滚
		8）TC 协调其管辖之下的所有分支事务，决定是否回滚

###### Seata实现2PC与传统2PC的差别：

- 架构层次方面，传统2PC方案的 RM 实际上是在数据库层，RM 本质上就是数据库自身，通过 XA 协议实现，而
  Seata的 RM 是以jar包的形式作为中间件层部署在应用程序这一侧的。
- 两阶段提交方面，传统2PC无论第二阶段的决议是commit还是rollback，事务性资源的锁都要保持到Phase2完成
  才释放。而Seata的做法是在Phase1 就将本地事务提交，这样就可以省去Phase2持锁的时间，整体提高效率。



###### PC

2PC即两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段（Prepare phase）、提交阶段（commit phase），2是指两个阶段，P是指准备阶段，C是指提交阶段。

在计算机中部分关系数据库如Oracle、MySQL支持两阶段提交协议【XA方案】，如下图：

- 准备阶段（Prepare phase）：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写本地的Undo/Redo日志，此时事务没有提交。（Undo日志是记录修改前的数据，用于数据库回滚，Redo日志是记录修改后的数据，用于提交事务后写入数*据文件）*

- 提交阶段（commit phase）：如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者*发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据事务管理器的指令执行提交或者回滚操***作，并释放事务处理过程中使用的锁资源。注意:必须在最后阶段释放锁资源。**

DTP模型定义如下角色：【非数据库层面】

- AP(Application Program)：即应用程序，可以理解为使用DTP分布式事务的程序。
- RM(Resource Manager)：即资源管理器，可以理解为事务的参与者，一般情况下是指一个数据库实例，通过资源管理器对该数据库进行控制，资源管理器控制着分支事务。
- TM(Transaction Manager)：事务管理器，负责协调和管理事务，事务管理器控制着全局事务，管理事务生命周期，并协调各个RM。全局事务是指分布式事务处理环境中，需要操作多个数据库共同完成一个工作，这个工作即是一个全局事务。
- DTP模型定义TM和RM之间通讯的接口规范叫XA，简单理解为数据库提供的2PC接口协议，**基于数据库的XA协议来实现2PC又称为XA方案。**



整个2PC的事务流程涉及到三个角色AP、RM、TM。AP指的是使用2PC分布式事务的应用程序；RM指的是资源管理器，它控制着分支事务；TM指的是事务管理器，它控制着整个全局事务。
1）在准备阶段RM执行实际的业务操作，但不提交事务，资源锁定；
2）在提交阶段TM会接受RM在准备阶段的执行回复，只要有任一个RM执行失败，TM会通知所有RM执行回滚操
作，否则，TM将会通知所有RM提交该事务。提交阶段结束资源锁释放。

XA方案的问题：
1、需要本地数据库支持XA协议。
2、资源锁需要等到两个阶段结束才释放，性能较差。





参考：

https://blog.csdn.net/qq_31960623/article/details/124681112