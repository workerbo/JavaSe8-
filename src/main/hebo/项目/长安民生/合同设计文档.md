> #### 合同技术设计文档



合同模块 

1.合同导入

​     多sheet页【异构，动态列】：主sheet页包含了合同头行、量价因子等信息 附属sheet页由量价因子行动态列生成价目表sheet。【同时各个事业部间存在差异】

​     动态转换：【通过注解添加校验信息】：涉及类型转换【字符串转时间、数字】，含义转换【快码、LOV】。其中每行的量价因子不一样，动态给当前合同行对应的价目表sheet列的注解上加校验code、处理完后清除动态code开始下一行【以合同行为维度处理整个EXCEL内容】。大量反射为了提高速度使用ReflectAsm。

​    动态校验：合同业务逻辑上的数据校验。例如唯一性，动态必填等。【涉及九个表】

​    公式解析：表达式的应用、通过正则使得公式的各个部分：函数、运算符、量库价库费用库因子得到解析，存入公式表

2.合同信息维护

​          根据字段显示控制其他字段的显示和编辑【同时控制样式改变 】

​          合同公式的录入与解析。【产品是通过输入一个表格记录、合同模块优化为直接在文本框中通过下来框间接输入输入】 

​          合同行量价因子到价目表的动态映射。通过映射号，将A表的一行映射为B表的固定列。同时前端页面动态拼接显示的列及列的快码、默认值等。

​          合同审批与日志记录：记录工作流节点和重要按钮节点。【通过AOP、审批流执行监听器】

​          推送OA:通过AOP监听后推送

​        合同附件

3.计费规则、价格假设规则、价格获取规则

​      规则的缓存

   

4.数据屏蔽

​    通过重写pagehelper的拦截SQL  字段下的值分给用户和角色  【屏蔽规则】   在表中使用屏蔽规则

###### 一、合同界面控制

###### 二、合同公式界面设计

###### 三、合同费用行量价选择界面设计

代码维护：CUX.CONTACT.FORMULA_VALUE_MODE



合同复制功能：合同关联关系不复制

合同删除功能：级联删除【包含合同关联关系】 合同行因子选择表删除因子需要去价目表删除对应列的数据！



###### 四：快码值集

查询量价因子、同名时优先量库因子，各事业部仅可查询到各自的量价因子  cuxContractQpSelectSql

 费用库LOV      selectExpenseTypeForLOV

 

1. 合同审核状态为非新建下都不可编辑、合同新建状态下前三个状态不能编辑、合同新建状态且来自其他系统的值不能编辑

2. 计费公式设计：避免生成规则公式处的难用  防止误输入  公式检查  代码兼容和复用【后台转成公式行】

​	

4. 合同公式页面1）AutoComplete多选时不能记录对象，同时无法知道最后编辑项。2)Muti-Select组件不能多次选择同一个待选项。  3）综合以上两点：采用单选AutoComplete【必须选中之后才能作为公式行数据】和表格【能删除和调整公式因子顺序】，同时用一个输入框展示编辑的公式。保存时校验公式。

 

CopySourceContactId区分新建和复制

 

 

合同逻辑：合同有不同的费用行、费用行根据业务字段及其值的组合有不同的价格和数量

 

因为自定义因子的存在导致先出现因子选择界面。在出现价目表。

 

\1. 公式界面【界面和校验】  2.头行细节【复制、关联等】  3.价目表  4.自定义界面【】

 

合同的主合同编码由结算维护，凡是有主合同编码关系的合同位于同一批次组中。

 

 

合同行费用因子选择界面和价目表界面分离考虑：1.一个因子对应列数。2.界面显示长度

 

\1. 是否判断字段加FLAG

\2. 使用存在于DTO的字段

\3. 新代码注意存在路径

\4. LOV中的SQL定义处描写取数逻辑

 

 

疑问项：

\1. 因子被引用能失效？

\2. 

 

 

 

\1. 公式界面

\2. 因子选择【序号、值列表】

\3. 主合同、内部合同关联【批次号】

\4. 复制功能

\5. 头行细节！

 

 

 